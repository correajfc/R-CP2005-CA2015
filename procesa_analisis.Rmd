# Procesamiento y análisis de datos {#anayproc}

El procesamiento de los datos se realizó  principalmente en @R-base. Se usó [QGIS](http://www.qgis.org/es/site/) para conectarse a los servicios WFS del IDESC y previsualizar las capas de información geográfica recolectada y la realización de algunos de los mapas detallados.

El código que implementa  los análisis está dividido en archivos para facilitar su lectura, cada uno de los cuales se encargan de transformar los datos de las fuentes y construir estructuras de datos necesarias para realizar las regresiones, las gráficas y los análisis de tipo estadístico y geoestadístico. Cada script implementa una fase de la metodología y produce resultados intermedios que facilitan seguir y reproducir dichas transformaciones sobre los datos de un dominio del problema. El archivo de `funciones.R` agrupa funciones que encapsulan funcionalidades recurrentes dentro del desarrollo del análisis. El script de `geodata.R` opera sobre los fuentes de datos geográficas necesarias para consolidar los índices de acceso a espacios verdes (EV),  los indicadores y variables de la estructura de física de los sectores censales y unidades geográficas del análisis. El script `arboles,R` consolida la información de cada uno de los individuos del censo arbóreo agregandolos por sector censal. El scrript `censopoblacion.R` consolida los datos del Censo de Población 2005. Los scripts `consolidarDatos.R` y `analisis_exploratorio.R` consolidan una única estructura con todos los datos y produce una serie de gráficas y medidas de correlación, que son base para la identificación de supuestos y selección de las variables independientes para los análisis estadísticos y las regresiones espaciales. Finalmente los script de `analisis_estadistico.R` y `analisis_geoestadistico.R` implementan las regresiones lineales y las regresiones espaciales respectivamente, así como los test y tablas para la verificación de los supuesto matemáticos y la verificación de la calidad de los resultados.  Todos estos están reunidos en un script que carga las librerías necesarias y ejecuta secuencialmente cada de los scripts descritos.
```{r code-main, eval=FALSE, echo=TRUE, fig.cap="Script principal"}
# Scrip principal para la la ejecución de los .R

#librerias

library(rgdal)
library(rgeos)
library(raster)
library(sp)

library(tidyverse)
library(magrittr)
library(stringr)

library(viridis)
library(RColorBrewer)
library(gridExtra)

library(visdat)
library(GGally)
library(wesanderson)

library(ggrepel)


#  correr los script en el orden correcto para realizar todos los calculos 

source("funciones.R")
source("geodata.R")
source("arboles.R")
source("censopoblacion.R")
source("consolidarDatos.R")
source("analisis_exploratorio.R")
source("analisis_estadistico.R")
source("analisis_geoestadistico.R")


```




## Capas de información geográfica

Para usar la información geográfica de la cartografía censal y la información del IDESC es necesario establecer un sistema de coordenadas común, en unidades métricas, que facilite integrar la información y produzca resultados consistentes. El sistema de coordenadas proyectadas que vamos a usar es @noauthor_magna-sirgas-cali_nodate. Para cargar y manipular los datos espaciales hacemos uso de las librerías `rgdal` [@R-rgdal], `rgeos` [@R-rgeos] y `sp` [@R-sp]. 

El siguiente mapa muestra los sectores urbanos con sus respectivos códigos de identificación descritos en la documentación que acompaña la cartografía.


```{r mapa-su,fig.width=6, fig.asp=1.41, fig.cap="Sectores Urbanos del Censo del 2005. Los sectores seleccionados están parcial o totalmente contenidos en el perímetro urbano 2015"}

ggplot()+
  geom_polygon(data = su.f,aes(x=long,y=lat,group=group),
               fill="lightgrey",color="white")+
  coord_equal()+
   with(su.setu_ccdgo, annotate(geom="text", x = long, y=lat, label = ids_su, 
                                size = 1.8,
                                color="black"))+
  theme_void()

```

La capa de manzanas es necesaria para refinar las capas de espacio verde y poder calcular el área de calle , área privada y otras métricas sobre la estructura de cada sector sector censal y que servirán como criterios para la selección de sectores urbanos a incluir en los análisis de regresión.

```{r mapa-manzana, fig.width=6, fig.asp=0.8, fig.cap="Coropleta del tamaño de manzana.Se usaron 10 grupos con aprox. el mismo número de observaciones"}
#pintar usando colores por quantil
manzanas.su.f%>%
  ggplot(aes(x=long,y=lat,group=group))+
  geom_polygon(aes(fill=cut_number(area_manzana,n = 10)))+
  coord_equal()+
  theme_void()+
  viridis::scale_fill_viridis(discrete = TRUE, direction = -1)
```

Las capas de equipamiento de la EEC y espacio público se consolidan en una sola capa conservando la mayor cantidad de información sobre la clasificación de los tipos de espacios disponibles. El resultado puede ver verse de forma total (ver figuara \@ref(fig:mapa-ev)) o por tipo de espacio (figuras \@ref(fig:mapa-ev-facet) y \@ref(fig:mapa-ev-color)).

```{r mapa-ev, fig.width=6, fig.asp=0.8, fig.cap="Espacio verdes consolidados y sectores urbanos"}
# espacios publicos (verdes)
base_plot.manzanas2 +
  geom_path(data = su.f,aes(x=long,y=lat,group=group),
            color="lightskyblue",
            size=0.5)+
  geom_polygon(data = ep.cali.f ,
               aes(x=long,y=lat,group=group),
               fill="deeppink",
               alpha=0.7)+
                                
  theme_void()
```


```{r mapa-ev-color, fig.width=6, fig.asp=0.8, fig.cap="Espacio verde por categoría"}
base_plot.manzanas2 + 
  geom_polygon(data = ep.cali.f ,
               aes(x=long,y=lat,group=group,
               fill=tolower(categoria)),
               alpha=1)+
  
  theme_void()+
  scale_fill_manual(name = "Tipo EV",values = palKata[c(9,8,7,6,1,5,4,10,2,3)])
```


```{r mapa-ev-facet,  fig.asp=1.5, fig.cap="Small Multiple del espacio verde por categoría"}
# facets por tipo de espacio 
  ggplot()+
  geom_polygon(data = su.f,aes(x=long,y=lat,group=group),
            fill="grey80",
            color ="white",
            size=0.1
            )+
  geom_polygon(data = ep.cali.f ,
               aes(x=long,y=lat,group=group),
               fill="deeppink",
               alpha=1)+
    coord_equal()+
  theme_void()+
  facet_wrap(~categoria, ncol = 4)+
  theme(strip.text.x = element_text(size = 8))
```

### Índices de acceso a espacios verdes

Para mejorar la lectura de esta sección se incluyen a continuación las ecuaciones que definen los índices de acceso seleccionados y las variantes definidas en este trabajo.

#### Índices de acceso basados en área {-}
**índice contenedor** (area_ep)
\begin{equation}
A^{C}_i =\sum_j{s_j} \;  \; \forall  j \in I
(\#eq:cont)
\end{equation}
donde $s_j$ es el área de cada espacio verde $j$ que pertenece al conjunto $I$ de EV dentro del sector $i$.

**índice contenedor porcentual** (area_ep.porcentaje)
\begin{equation}
A^{C_p}_i =1/a_i\sum_j{s_j} \;  \; \forall  j \in I
(\#eq:n-cont)
\end{equation}
donde $a_i$ es el área del sector $i$.

**índice área disponible en radio** (ia.areas.1000)
\begin{equation}
A^{AR}_i= \sum_{\int R_b }{(s_j}  \;  \; \forall  j \in I_{R_b} \; 
(\#eq:area-radio)
\end{equation}
donde $R_b$ es el radio de búsqueda,  $s_j$ es el área de cada espacio verde $j$ que pertenece al conjunto $I_{R_b}$ de EVs en el radio de búsqueda.

**índice porcentual de área disponible en radio** (ia.areas.1000.porcentaje)
\begin{equation}
A^{AR_p}_i= 1/a_t \sum_{\int R_b }{(s_j}  \;  \; \forall  j \in I_{R_b} \; 
(\#eq:area-radio)
\end{equation}
donde $a_t$ es el área total de espacio verde en la ciudad.

#### Índices de acceso basados en distancia {-}

**costo de viaje** (ia.costoviaje)
\begin{equation}
A^{T}_i =\sum_j{d_{ij}} \; \; \forall  j \in I_t
(\#eq:costo)
\end{equation}
donde $d_{ij}$ es la distancia del centriode del sector $i$ al espacio $j$ e $I_t$ es el conjunto de todos los epacios verdes de la ciudad. 

**costo de viaje normalizado** (ia.costo.n)
\begin{equation}
\bar{A}^{T_n}_i =A^{T}_i/N 
(\#eq:n-costo)
\end{equation}
donde $N$ es el número total de espacio verdes en la ciudad.

**distancia mínima** (ia.mindist)
\begin{equation}
A^{M}_i=min\left | d_{ij} \right | \forall  j \in I_t
(\#eq:min-dist)
\end{equation}

#### Índices de acceso mixtos {-}

**razón área distancia** (ia.A.D)
\begin{equation}
A^{AD}_i= \sum_{\int R_b }{s_j/d_{ij}}  \;  \; \forall  j \in I_{R_b} \; 
(\#eq:area-dist)
\end{equation}
donde $R_b$ es el radio de búsqueda,  $s_j$ es el área de cada espacio verde $j$, $d_{ij}$ es la distancia del centriode del sector $i$ al espacio $j$  que pertenecen al conjunto $I_{R_b}$ de EVs en el radio de búsqueda. 

**razón área disponible distancia** (ia.areas.dist)
\begin{equation}
\bar{A}^{AD}_i= \frac{\sum_{\int R_b }{s_j}}{\sum_{\int R_b }{d_{ij}}}  \;  \; \forall  j \in I_{R_b} \; 
(\#eq:areas-dists)
\end{equation}


Con los datos consolidados se calculan las áreas de los espacios verdes al interior de cada sector censal, para calcular los índices de acceso tipo contenedor (ecuación \@ref(eq:cont)) interceptando los espacio verdes con los sectores urbanos (ecuación \@ref(eq:n-cont)). También se obtuvo una versión del índice contenedor como en porcentaje del área del SU. El cálculo de los índices de costo de viajes (ecuación \@ref(eq:costo)) y costo de viaje normalizado (ecuación \@ref(eq:n-costo)) se obtiene creado una matriz de distancia entre los centroides de los sectores censales y cada uno de los espacios verdes. De esta matriz de distancia también se obtiene el índice de distancia mínima (ecuación \@ref(eq:min-dist)). 

Los mapas de los índices de acceso basados en distancia se muestran en la figura \@ref(fig:mapas-ia-distancia)

```{r mapas-ia-distancia, fig.asp=0.8, fig.cap="Small Multiple de los indices de acceso a EV basados en distancia en escala continua"}

pl_acceso_dist<-plots_map_su_df(metricas.acceso.df,metricas.acceso[c(1,2,7)])
grid.arrange(grobs =pl_acceso_dist, nrow =1)
```

```{r mapas-ia-distancia-deciles, fig.asp=0.8, fig.cap="Small Multiple de los indices de acceso a EV basados en distancia usando deciles"}
su.f %>% dplyr::select(-area_su)  %>%
  left_join(metricas.acceso.ntl.long, by = c("id"="SETU_CCDGO")) %>%
  filter(metricas.acceso %in% metricas.acceso[c(1,2,7)]) %>%
  ggplot()+
  geom_polygon(aes(x= long, y = lat, group = group, fill = factor(valores)))+
  coord_equal()+
  scale_fill_viridis( name = "deciles",
                      direction = 1, 
                      discrete = T, 
                      na.value = "grey50",
                      guide = guide_legend(direction = "horizontal",
                                           label.position = "bottom",
                                           title.position = 'top',
                                           nrow = 1))+
  facet_wrap(~metricas.acceso, nrow = 1)+
  tema_lgnd_abajo()
```


Además de los índices basados en distancia y el tipo contenedor se calcularon índices de acceso basados en el área de espacio verde en un radio de 1000 metros. Estos índices muestran un dimensión relacionada no con solo con el acceso sino con la cantidad de espacio disponible en el radio de busqueda definido desde el centroide del sector censal. Para hacernos una idea del radio de búsqueda seleccionado, el siguiente mapa muestra los radios búsqueda y los espacios verdes. 

```{r mapa-rango1km,  fig.asp=0.8, fig.cap="Espacio verdes y rango de 1 km desde centriodes de SU"}
ggplot()+
  geom_polygon(data = s_1000_df, 
               aes(x=long,y=lat,group=group),
               fill = "salmon",
               alpha = 0.2)+
  geom_path(data = su.f,aes(x=long,y=lat,group=group),
            color="grey40",
            size=0.4)+
  geom_polygon(data = ep.cali.f ,
               aes(x=long,y=lat,group=group),
               fill="royalblue",
               alpha=0.5)+
  coord_equal()+
  theme_void()
```



Los índices de acceso basados en área descritos en las ecuaciones \@ref(eq:cont),\@ref(eq:n-cont) y\@ref(eq:area-radio) se resumen en la siguiente gráfica.

```{r mapas-ia-area,   fig.asp=1, fig.cap="Small Multiple de los indices de acceso a EV basados en área usando escala continua"}
pl_acceso_dist<-plots_map_su_df(metricas.acceso.df,metricas.acceso[c(8,9,10,11)])
grid.arrange(grobs =pl_acceso_dist, ncol =2)

```

```{r mapas-ia-area-deciles, fig.asp=0.8, fig.cap="Small Multiple de los indices de acceso a EV basados en distancia usando deciles"}
su.f %>% dplyr::select(-area_su)  %>%
  left_join(metricas.acceso.ntl.long, by = c("id"="SETU_CCDGO")) %>%
  filter(metricas.acceso %in% metricas.acceso[c(8,9,10,11)]) %>%
  ggplot()+
  geom_polygon(aes(x= long, y = lat, group = group, fill = factor(valores)))+
  coord_equal()+
  scale_fill_viridis( name = "deciles",
                      direction = 1, 
                      discrete = T, 
                      na.value = "grey50",
                      guide = guide_legend(direction = "horizontal",
                                           label.position = "bottom",
                                           title.position = 'top',
                                           nrow = 1))+
  facet_wrap(~metricas.acceso, nrow = 1)+
  tema_lgnd_abajo()
```

En la búsqueda de índices de acceso más complejos que reflejen el acceso en distancia y la cantidad de área disponible desde cada sector urbano se construyeron índices similares a el índice de distancia de a pie (ecuación \@ref(eq:walkdist) que se basan en la razón entre el área a la que se accede y la distancia a la que se encuentra del centroide del sector. Dos nuevos índices se proponen en este trabajo: ia.areas.dist (ecuación \@ref(eq:areas-dists)) como la suma de las áreas en el rango de 1 km desde el centroide del SU dividido la suma de las distancia a esos EV; ia.A.D (ecuación \@ref(eq:area-dist)) , que es la suma de las razones entre el área del espacio verde $j$ dividido entre la distancia $d_{ij}$ desde el centroide del SU $i$ al EV $j$. La siguiente gráfica muestra las métricas propuestas.

```{r mapas-ia-area-dist, fig.asp=0.8, fig.cap="Small Multiple de los indices de acceso a EV basados en área y distancia usando escala continua"}
pl_acceso_mix<-plots_map_su_df(metricas.acceso.df,metricas.acceso[c(13:14)])
grid.arrange(grobs =pl_acceso_mix, ncol =2)

```

```{r mapas-ia-area-dist-deciles, fig.asp=0.8, fig.cap="Small Multiple de los indices de acceso a EV basados en distancia usando deciles"}
su.f %>% dplyr::select(-area_su)  %>%
  left_join(metricas.acceso.ntl.long, by = c("id"="SETU_CCDGO")) %>%
  filter(metricas.acceso %in% metricas.acceso[c(13,14)]) %>%
  ggplot()+
  geom_polygon(aes(x= long, y = lat, group = group, fill = factor(valores)))+
  coord_equal()+
  scale_fill_viridis( name = "deciles",
                      direction = 1, 
                      discrete = T, 
                      na.value = "grey50",
                      guide = guide_legend(direction = "horizontal",
                                           label.position = "bottom",
                                           title.position = 'top',
                                           nrow = 1))+
  facet_wrap(~metricas.acceso, nrow = 1)+
  tema_lgnd_abajo()
```

Además de los mapas es de interes observar la distribución en frecuencia de las métricas de acceso. La siguiente gráfica se observan los histogramas de las metricas calculadas.

```{r hist-acceso,  fig.asp=1.5, fig.cap="Small Multiple de los indices de acceso a EV basados en distancia usando deciles"}
analisis.cali.df %>% select(one_of(metricas.acceso[c(1,2,7,8,9,10,11,13,14)])) %>%
  gather( key = metricas.acceso,
          value = valores,
          ia.costoviaje:ia.A.D) %>%
  ggplot()+
  geom_histogram(aes(x = valores),bins = 30, 
                 color = "white", fill="steelblue")+
  facet_wrap(~metricas.acceso, scales = "free", ncol = 2)
```


Finalmente se muestra el código en R que calcula los índices presentados, y el resumen de los índices calculados. 

```{r resumen-ia}
summary(analisis.cali.df[,metricas.acceso[c(1,2,7,8,9,10,11,13,14)]])
```

```{r code-indices-acceso, eval= FALSE, echo=TRUE}
# matriz distancia entre centriodes y espacios
m.dist.ctrdsu.ep<-gDistance(ep.cali,centroides.su, byid = T) 
#cuando el punto esta dentro del poligono el valor que rertorna es 0
# por ese motivo le pondremos 10 a valores = 0 o entre 0 y 10 para 
# evitar problemas al invertir la matriz y mejorar la conistencia del indices
# con valores inversos a la distancia
m.dist.ctrdsu.ep[m.dist.ctrdsu.ep < 10]<- 10
# matriz consicion de estar a 1000 del centriodo
is.1000.ep<-gWithinDistance(ep.cali,centroides.su,1001, byid = T)
# cantidad de espacio verdes en radio de 1000 m de los centriodes del sector urbano
num.ep.1000<-apply(is.1000.ep,1,function(x)  sum(x,na.rm =T))
#distancias de Espacio publicos a 1000 del centriode de SU
a<-m.dist.ctrdsu.ep*is.1000.ep

# distancia minima distinta de 0
ia.mindist<-apply(m.dist.ctrdsu.ep,1,function(x)  min(x[x!=0]))
index.min<-apply(m.dist.ctrdsu.ep,1,function(x)  which.min(x[x!=0]))
ia.area.mindist<-ep.cali$area_ep[index.min]/ia.mindist
# suma de las distancias a cada EP por centriode 
ia.costoviaje<-apply(m.dist.ctrdsu.ep,1,sum)
# suma de las distancias a cada EP ubicado a menos de 1000 m del centriode
ia.1000<-apply(a,1,function (x) sum(x))
ia.1000[ia.1000==0]<-NA
ia.1000.n<-ia.1000/num.ep.1000
# indice de la suma de las areas en el rango de un 1 km del sector censal
ia.areas.1000<-is.1000.ep %*% ep.cali$area_ep %>% as.vector()
# indice de area disponible en el radio de 1km como porcentaje del area total 
# disponible 

ia.areas.1000.porcentaje<-ia.areas.1000/sum(ep.cali$area_ep)

# matriz de distancias inversas de centriode su a espacios verdes  
m.dist.ctrdsu.1000.ep.inv<-1/a
b<-m.dist.ctrdsu.1000.ep.inv*is.finite(m.dist.ctrdsu.1000.ep.inv) # eliminar infinitos
# suma de inverso de las distancias a cada EP ubicado a menos de 1000 m del centriode
ia.1000.inv<-apply(b,1,function (x) sum(x,na.rm = T))
ia.1000.inv[ia.1000.inv==0]<-NA
#razon entre Area del EP y distancia al centriode
A.D<-t(t(b)*ep.cali$area_ep)

# sumatoria de la razon entre Area del EP y distancias de ese EP al centriode
ia.A.D<-apply(A.D,1,function (x) sum(x,na.rm = T))
class(ia.costoviaje)
summary(ia.costoviaje)
length(ia.costoviaje)
summary(ia.1000.inv)
length(ia.A.D)
summary(ia.A.D)

# consolidadcionde indices calculados
ia.ev<-data.frame(su$SETU_CCDGO,ia.costoviaje)
ia.ev$ia.costo.n<-ia.ev$ia.costoviaje/dim(m.dist.ctrdsu.ep)[2]
ia.ev<-bind_cols(ia.ev,data.frame(ia.1000,
                                  ia.1000.inv,
                                  ia.1000.n,
                                  ia.areas.1000,
                                  ia.areas.1000.porcentaje
                                  ))
ia.ev$ia.r300<-300*ia.1000.inv
ia.ev<-ia.ev%>%dplyr::rename(SETU_CCDGO=su.SETU_CCDGO)
ia.ev$ia.mindist<-ia.mindist
ia.ev$ia.area.mindist<-ia.area.mindist
ia.ev$ia.A.D<-ia.A.D
smry.area<-summary(ep.cali$area_ep)
ia.ev$ia.r300.Amedia<- 300/smry.area[4]*ia.ev$ia.A.D
ia.ev$ia.r300.Amediana<- 300/smry.area[3]*ia.ev$ia.A.D
ia.ev$ia.areas.dist<-ia.areas.1000/ia.1000


```



## Datos del censo arbóreo 2015 {#sec-ca2015}

El censo arbóreo del año 2015 consolidó un inventario de la vegetación de la ciudad compuesto por `r sum(altura_copa_por_cobertura$cantidad)` individuos. Entre las variables que categorizan los individuos censados están el tipo de emplazamiento, tipo de suelo que cubre la vegetación, la edad, la vitalidad, tipo de vegetación y sus caratetiristicas dasometricas p.ej la altura, el diamtro de la copa, altura y diametro del pecho, etc ..., entro otras relacionadas con el estado fitosanitario y daños físicos.

A continuación se presentan una serie de tablas que resumen las caraterísticas seleccionadas en la tabla \@ref(tab:vars-AU) para el análisis (por tipo de vegetación \@ref(tab:ca2015-vegetacion), por edad \@ref(tab:ca2015-edad) y por emplazamiento \@ref(tab:ca2015-emplazamiento)), antes de aplicar los criterios de seleccón de los individuos arbóres para este estudio.

```{r ca2015-vegetacion}
knitr::kable(altura_copa_por_vegetacion,col.names = c("Tipo de vegetación", "altura media","diámetro medio","cantidad"),digits = 2, caption = "Resúmen CA2015 por tipo de vegetación")

```

```{r ca2015-edad}
knitr::kable(altura_copa_por_edad,col.names = c("Edad", "altura media","diámetro medio","cantidad"),digits = 2, caption = "Resúmen CA2015 por edad")

```

```{r ca2015-emplazamiento}
knitr::kable(altura_copa_por_emplazamiento,col.names = c("Emplazamiento", "altura media","diámetro medio","cantidad"),digits = 2,caption = "Resúmen CA2015 por emplazamiento")

```

Existe una diferencia de 10 años entre censo de población de 2005 y el censo arbóreo de la ciudad de Cali. Aunque esto pueda parecer una situación que reduce la legitimidad de los resultados que se hayen en este estudio, autores como @boone2010landscape y @schwarz_trees_2015 reconocen que los paisajes que vemos hoy son legados de patrones de consumo pasados, y que en el caso de la vegetación urbana tratamos con organismos de larga vida que pueden tardar mucho tiempo en establecerse y crecer. En contraste, la estructura social de las ciudades puede cambiar más rápidamente. 

Como se menciona en la metodología, la apuesta para reducir la brecha es la exclusión de los árboles jóvenes del inventario, que posiblemente no estaban ahí en 2005. Aunque no conocemos las tasa anual de tala de árboles en la ciudad, y dado es posible que una parte importante de los árboles jóvenes haya reemplazado a los los que fueron talados, no parece realista mantener el inventario entero. 

Aunque en general toda la vegetación aporta beneficios ambientales a los habitantes, en este estudio descartamos la vegetación arbustiva y los árboles, palmas y bambú de menos de 1.9 m de altura para circunscribirnos a los individuos más desarrollados. 

Una vez aplicado este filtro contamos con `r nrow(AU_analsis)` individuos. Las tablas de resumen para la selección de indivuduos con base en estos criterios se muestran a contiunuación.



```{r ca2015sel-vegetacion}
res_vegetacion<-AU_analsis %>% 
  group_by(vegetacion) %>% 
  summarise(altura_media_vegetacion=mean(altura_arbol),
            diametro_medio_copa_vegetacion = mean(diametro_copa),cantidad=n()) 


knitr::kable(res_vegetacion,col.names = c("Tipo de vegetación", "altura media","diámetro medio","cantidad"),digits = 2, caption = "Resúmen selección CA2015 por tipo de vegetación")

```

```{r ca2015sel-edad}


res_edad<-AU_analsis %>% 
  group_by(edad) %>% 
  summarise(altura_media_vegetacion=mean(altura_arbol),
            diametro_medio_copa_vegetacion = mean(diametro_copa),cantidad=n()) 

knitr::kable(res_edad,col.names = c("Edad", "altura media","diámetro medio","cantidad"),digits = 2, caption = "Resúmen selección CA2015 por edad")

```

```{r ca2015sel-emplazamiento}
res_emplazamiento<-AU_analsis %>% 
  group_by(emplazamiento) %>% 
  summarise(altura_media_vegetacion=mean(altura_arbol),
            diametro_medio_copa_vegetacion = mean(diametro_copa),cantidad=n()) 

knitr::kable(res_emplazamiento,col.names = c("Emplazamiento", "altura media","diámetro medio","cantidad"),digits = 2,caption = "Resúmen selección CA2015 por emplazamiento")

```

Para indagar sobre la distribución de estos individuos y no quedarnos con los resúmenes estadísticos se muestran a continuación los datos desagregados gráficamente cada una de las variables categóricas y las características físicas del arbolado: altura, diámetro de la copa y su ubicación en la ciudad.

En primer lugar indagamos sobre las diferencias de diámetro y altura por tipo de vegetación. La figura \@ref(fig:au-veg) muestra claramente las diferencias físicas entre los árboles (desarrollan mayor tamaño y con mayor número de individuos), el bambú y las palmas (más altos que anchos y en menor número) de la ciudad. Los árboles catalogados como secos, hace 10 años estaban vivos y los mantenemos en la selección de individuos. 


```{r au-veg,  fig.asp=1, fig.cap="caraterísticas por tipo de vegetacion"}
#caraterísticas por tipo de vegetacion
AU_analsis %>% 
  ggplot()+
  geom_point(aes(y=altura_arbol,x=diametro_copa),alpha=0.1, color ="forestgreen" )+
  coord_equal()+
  theme_bw()+
  facet_wrap( ~ vegetacion, nrow = 2 )
```

Otra característica interesante para buscar condiciones que afectan el desarrollo del arbolado, representado por la altura y el diámetro son el tipo de lugares que conforman el espacio público donde se encuentran el mayor número de ellos. En la figura \@ref(fig:au-emplaz-veg) se observa la desagregación de los individuos por tipo de emplazamiento en gráficas individuales de altura y diámetro, y en color el tipo de vegetación. Es notorio en la figura que los parques urbanos  y escenarios deportivos son los equipamientos que mayor cantidad de individuos y más desarrollos alojan. Caso aparte son los andenes y separadores viales como se ve en la tabla \@ref(tab:ca2015sel-emplazamiento) y el gráfico alojan `r round((92198+28924)*100/nrow(AU_analsis),digits =2)`% de los individuos. Esto puede ser un hecho que incita a incluir elementos estructurales en los modelos que explican desde aspectos estructurales de los barrios la cobertura de copa. Por supuesto las rondas de ríos y canales dada su disponibilidad de agua condicionan el desarrollo de los individuos arbóreos y su cantidad. 

```{r au-emplaz-veg,  fig.asp=1.5, fig.cap="Caraterísticas por tipo de vegetación y emplazamiento"}
AU_analsis %>% 
  #filter(vegetacion %in% c("Arbol","Bambu","Palma")) %>%
  ggplot()+
  geom_point(aes(y=altura_arbol,x=diametro_copa,color=vegetacion),alpha=0.1)+
  scale_color_brewer(palette = "Dark2")+
  coord_equal()+
  facet_wrap(~emplazamiento , ncol = 4 ,labeller = label_wrap_gen())+
  guides(colour = guide_legend(override.aes = list(alpha=1)))+
  tema_lgnd_up()
```


Otra forma de ver los datos de resumen de las tabla \@ref(tab:ca2015sel-emplazamiento) y que completa la visión sobre la distribución de los datos en relación al desarrollo físico de los individuos arbóreos es la distribución de los diámetros (figura \@ref(fig:au-diametro-emp))y las alturas (figura \@ref(fig:au-altura-emp)) en relación con el emplazamiento. En ambas gráficas el punto rojo representa el valor promedio


```{r au-diametro-emp,  fig.asp=0.8, fig.cap="Variabilidad del diámetro de copa por emplazamiento"}
AU_analsis %>% 
ggplot( aes(x=emplazamiento,y=diametro_copa))+
  geom_jitter(position = position_jitter(0.3),alpha=0.1, color = "forestgreen")+ 
  stat_summary(fun.y = mean, geom = "point", shape = 18, size = 3, color = "tomato")+
  stat_summary(aes(label=round(..y..,digits = 2)),fun.y = mean, geom = "text", color = "tomato", hjust = -0.5, size =3)+
  coord_flip()+
  tema_lgnd_up()

```

```{r au-altura-emp,  fig.asp=0.8, fig.cap="Variabilidad de la altura de los arboles por emplazamiento"}
AU_analsis %>% 
  ggplot( aes(x=emplazamiento,y=altura_arbol))+
  geom_jitter(position = position_jitter(0.3),alpha=0.1, color = "forestgreen")+ 
  stat_summary(fun.y = mean, geom = "point", shape = 18, size = 3, color = "tomato")+
  stat_summary(aes(label=round(..y..,digits = 2)),fun.y = mean, geom = "text", color = "tomato", hjust = -0.5, size =3)+
  coord_flip()+
  tema_lgnd_up()

```

Finalmente en la figura \@ref(fig:au-geo-emp) graficamos los individuos en pequeños mapa por tipo de emplazamiento para observar su distribución geográfica. Es notorio que los árboles están distribuidos en toda la ciudad dada la disponibilidad de andenes aptos para alojarlos. Esto invita a explorar la relación que pueda existir entre el tamaño de los andenes de los barrios y el desarrollo físico de los individuos, ya que las vías con separadores viales y en consecuencia con más espacio para que árboles de mayor tamaño puedan desarrollarse es consistente con el valor medio de la altura y el diámetro sean mayores que el de los andenes. Sin embargo este hecho escapa del alcance de este trabajo y puede ser indagado por otras investigaciones. 

```{r au-geo-emp,  fig.asp=1.5, fig.cap="Small multiples de los individuos arbóreos por emplazamiento"}
# puntos por e,mplazamiento
base_plot.manzanas + geom_point(data = AU_analsis,
                                aes(x = Este, y = Norte),
                                size=0.01,
                                color="forestgreen",
                                alpha=0.1)+
  theme_void()+
  facet_wrap(~emplazamiento , ncol = 4 ,labeller = label_wrap_gen())

```

Antes de agregar (enmascarar) los datos usando los sectores censales es interesante inspeccionar el efecto que tiene usar unidade regulares o de tamaños no uniformes como los sectores urbanos en las coberturas de copa. Para ello podemos usar hexágonos de 250 metros de ancho que cubren completamente el territorio. La figura \@ref(fig:au-geo-hex) se evidencia que existen cinturones y lugares de alta concentración de individuos y en consecuencia de mayor cobertura de copa. 

```{r au-geo-hex,  fig.asp=0.8, fig.cap="Suma de cobertura por hexagonos"}
# suma de cobertura por hex
p.hex.copa  <-base_plot.manzanas+ stat_summary_hex(data = AU_analsis,
                                 aes(x = Este, y = Norte, z = area_copa),
                               binwidth = c(250, 250),
                               fun = sum 
                               )+
    geom_path(data = su.f,
                 aes(x = long, y = lat, group = group),
              color ="grey50",
              size=0.2)+
    coord_equal()+
    scale_fill_viridis(name="área \n copa",direction = 1)+
    theme_void()
 p.hex.copa   
```

En la figura \@ref(fig:au-su-acopa) usamos los SUs para agregar los valores de área de copa. Se observa como se reduce un poco la continuidad, y se intensifica el efecto de la agregación en algunos sectores y se atenúa en otros (las figuras \@ref(fig:comp-su-hex-copa) y \@ref(fig:comp-su-hex-numarb) muestran el efecto de la agregación en el área de copa y en el número de individuos, respectivamente ). 

```{r au-su-acopa,  fig.asp=0.8, fig.cap="Area de copa por sector censal"}
p.su.copa<-su.f %>% dplyr::select(-area_su)  %>%
  left_join(analisis.cali.df,by = c("id"="SETU_CCDGO")) %>%
  ggplot()+
  geom_polygon(aes(x= long, y = lat, group = group, fill = area_copa))+
  coord_equal()+
  theme_void()+
  scale_fill_viridis(name = "área \n copa", direction = 1 )
p.su.copa

```


```{r comp-su-hex-copa, fig.cap="Agregación de area de copa por hexagonos y SU"}
grid.arrange(p.hex.copa,p.su.copa, ncol = 2)


```

```{r comp-su-hex-numarb, fig.cap="Agregación de número de árboles por hexagonos y SU"}
grid.arrange(p.hex.arboles,p.su.arboles, ncol = 2)
```

Esto sugiere que usar valores porcentuales para la cobertura en relación con el área de los SU o del área no-privada de cada sector puede ser una mejor medida para caracterizar el beneficio real en cada sector censal. En razón a esta consideración y las reflexiones sobre el tema en @schwarz_trees_2015, que sugiere que la distinción entre áreas privadas y públicas también puede hablar de las superficies plantables totales que están disponibles para aumentar la cobertura de copa, calculamos entonces el porcentaje de cobertura de copa respecto del área total sector urbano y respecto del área de espacio público (área del sector censal menos el área de las manzanas privadas)^[La capa de espacio público consolidada previamente nos permite identificar las manzanas de un SU que son espacio público, y por tanto podemos obtener el área que es vía pública, las manzanas que son privadas y las manzanas que son espacio público. Así el área pública es igual a la suma del área de calle más las manzanas de espacio público o al área de SU menos el área de manzanas privadas]. Las medidas porcentuales respecto del área total y pública permiten hacer una comparación más justa entre las diferentes unidades pues relativiza los niveles totales de área de copa. Un hecho que apoya el uso de medidas en relación al espacio público de un sector censal es que el CA2015 solo se realizó para la vegetación en lugares públicos, sobre la calle o vía pública. 

En consecuencia se calcularon las métricas de área de copa en relación al área del sector urbano (`cobertura_copa.su`) y al área pública del sector urbano (`cobertura_copa.ap`). En la figura \@ref(fig:metricas-cobertura-cont) se ven los mapas en escala continua y en la figura \@ref(fig:metricas-cobertura-deciles) se reproducen los mismos mapas usando una escala en deciles. Visualmente, cobertura de copa parece en espacio público parece aproximarse mejor a los patrones de distribución que se evidencia cuando usamos la división uniforme del terreno en hexágonos (figura \@ref(fig:au-geo-hex)), razón por la cual la preferiremos sobre `cobertura_copa.su` para los análsis.


```{r metricas-cobertura-cont,fig.asp=0.618, fig.cap="Métricas de cobertura de copa: área de copa, porcentaje de área de copa respecto del sector censal (cobertura_copa.su) y cobertura de copa respecto del área pública (cobertura_copa.ap)"}
pl_copa<-plots_map_su_df(analisis.cali.df,metricas.ca[c(1,5,6)])
grid.arrange(grobs =pl_copa, nrow = 1)
```


```{r metricas-cobertura-deciles, fig.cap="Métricas de cobertura de copa: área de copa, porcentaje de área de copa respecto del sector censal y cobertura de copa respecto del área pública"}
su.f %>% dplyr::select(-area_su)  %>%
  left_join(metricas.ca.ntl.long,by = c("id"="SETU_CCDGO")) %>%
  filter(metricas.arboles %in% metricas.ca[c(1,5,6)]) %>%
  ggplot()+
  geom_polygon(aes(x= long, y = lat, group = group, fill = factor(valores)))+
  coord_equal()+
  scale_fill_viridis( name = "deciles",
                      direction = 1, 
                      discrete = T, 
                      na.value = "grey50",
                      guide = guide_legend(direction = "horizontal",
                                           label.position = "bottom",
                                           title.position = 'top',
                                           nrow = 1))+
  facet_wrap(~metricas.arboles, nrow = 1)+
  tema_lgnd_abajo()
```

Finalmente se muestra los histogramas y el resúmen de las métricas de cobertura arbórea calculadas. 

```{r hist-metricas-copa, fig.cap="Histograma de las métricas de la cobertura de copa"}
#histogramas arboles -----

analisis.cali.df %>% select(one_of(metricas.ca[c(1,5,6)])) %>%
  gather( key = metricas.arboles,
          value = valores,
          area_copa:cobertura_copa.ap) %>%
  ggplot()+
  geom_histogram(aes(x = valores),bins = 30,
                 color = "white", fill="forestgreen")+
  facet_wrap(~metricas.arboles, scales = "free", ncol = 1)
```

```{r resumen-cobcopa}
analisis.cali.df %>% select(one_of(metricas.ca[c(1,5,6)])) %>%
summary()
```




## Datos del censo de población

Los datos del censo fueron descargados del aplicativo con que cuenta el DANE para dar acceso al censo de población 2005 [@censo_sistema_dane]. Los datos agregados por sectores censales los inspeccionamos a través de los resúmenes estadistico, histogramas y mapas, de forma análoga a lo realizado hasta ahora con el resto de variables. 

### Característica de la población

La tabla \@ref(tab:vars-poblacion) resumen las variables consideradas inicialmente en este trabajo, sin embargo, algunas de ellas no contienen suficiente variabilidad o el número de individuos es muy bajo en comparación con el total de la población. En la tabla \@ref(tab:totales-poblacion) se observa el bajo número de personas que pertenecen al pueblo Rom (gitanos), Palenqueros de San Basilio (departamento de Bolívar) y de Raizales del Archipiélago de San Andrés, Providencia y Santa Catalina (SAI), por lo que son descartados del análisis. La población indígena es también baja, pero no tanto como para descartarla inmediatamente.

```{r totales-poblacion}
nombre_fila<-c("Población Total","Población afrodescendiente, negros o mulatos","Población indígena","Población Rom","Población Palenqueros","Población raizales de SAI")
tot_pob<-totales.cali[11:16] %>% as_vector(.,"numeric")
tabla.tmp<-data.frame(nombre_fila,unname(tot_pob))
knitr::kable(tabla.tmp, col.names = c("Tipo","Cantidad") ,caption = "Totales de población en la ciudad de Cali")

```

La figura \@ref(fig:mapas-poblacion-cont) muestra los datos de las variables de población en espacio geografico de la ciudad usando una escala continua y la figura \@ref(fig:mapas-poblacion-deciles) lo hace usando una escala discreta (deciles).

```{r mapas-poblacion-cont, fig.asp=1.5,fig.cap="Mapas de las variables de población seleccionadas (escala contínua)"}

pl_poblacion<-plots_map_su_df(analisis.cali.df,metricas.poblacion[c(2,3,4,6,7)])
grid.arrange(grobs =pl_poblacion, nrow =2)

```

```{r mapas-poblacion-deciles, fig.asp=1.2,fig.cap="Mapas de las variables de población seleccionadas (en deciles)"}
su.f %>% dplyr::select(-area_su)  %>%
  left_join(metricas.poblacion.ntl.long, by = c("id"="SETU_CCDGO")) %>%
  filter(metricas.poblacion %in% metricas.poblacion[c(2,3,4,6,7)]) %>%
  ggplot()+
  geom_polygon(aes(x= long, y = lat, group = group, fill = factor(valores)))+
  coord_equal()+
  scale_fill_viridis( name = "deciles",
                      direction = 1, 
                      discrete = T, 
                      na.value = "grey50",
                      guide = guide_legend(direction = "horizontal",
                                           label.position = "bottom",
                                           title.position = 'top',
                                           nrow = 1))+
  facet_wrap(~metricas.poblacion, nrow = 2)+
  tema_lgnd_abajo()
```

Los histogramas de estas variables en la figura \@ref(fig:hist-poblacion) siguen la tendencia que se ha venido observando en los histogramas de cobertura arbórea y de variables de acceso a espacios verdes : las distribuciones no son *normales*, tienen una inclinación a la derecha.

```{r hist-poblacion, fig.asp=1,fig.cap="Histogramas de las variables de población "}
# histogramas datos poblacion  
analisis.cali.df %>% select(one_of(metricas.poblacion)) %>%
  gather( key = metricas.poblacion,
          value = valores,
          superior_postgrado:con_alguna_limitacion,indigena,negro_mulato_afrocolombiano) %>%
  ggplot()+
  geom_histogram(aes(x = valores),bins = 30, 
                 color = "white", fill="magenta")+
  facet_wrap(~metricas.poblacion, scales = "free", ncol = 2)
```

Además de las variables seleccionadas podemos calcular indicadores que se relacionan con el teóricamente como la densidad de población: dado que los árboles compiten por el espacio con los seres humanos es de esperarse que a mayor cantidad de personas haya menos lugar para los árboles. Podemos de nuevo calcular indicadores porcentualización de las condiciones de la población para facilitar la comparaciones y acentuar las diferencias entre los diferente sectores.

A continuación se muestran los mapas en escala continua (figura \@ref(fig:mapas-poblacion-mod-cont)), discreta (figura \@ref(fig:mapas-poblacion-mod-deciles)) e histogramas (figura \@ref(fig:hist-poblacion-mod)) de los indicadores porcentuales de las condiciones y la densidad de población.

```{r mapas-poblacion-mod-cont, fig.asp=1.5,fig.cap="Mapas de las variables de población seleccionadas como porcentajes (escala contínua)"}

pl_poblacion<-plots_map_su_df(analisis.cali.df,metricas.poblacion.mod[c(1,2,3,5,6)])
grid.arrange(grobs =pl_poblacion, nrow =2)

```

```{r mapas-poblacion-mod-deciles, fig.asp=1.2,fig.cap="Mapas de las variables de población seleccionadas como porcentajes (en deciles)"}
su.f %>% dplyr::select(-area_su)  %>%
  left_join(metricas.poblacion.mod.ntl.long, by = c("id"="SETU_CCDGO")) %>%
  filter(metricas.poblacion.mod %in% metricas.poblacion.mod[c(1,2,3,5,6)]) %>%
  ggplot()+
  geom_polygon(aes(x= long, y = lat, group = group, fill = factor(valores)))+
  coord_equal()+
  scale_fill_viridis( name = "deciles",
                      direction = 1, 
                      discrete = T, 
                      na.value = "grey50",
                      guide = guide_legend(direction = "horizontal",
                                           label.position = "bottom",
                                           title.position = 'top',
                                           nrow = 1))+
  facet_wrap(~metricas.poblacion.mod, nrow = 2)+
  tema_lgnd_abajo()
```

```{r hist-poblacion-mod, fig.asp=1,fig.cap="Histogramas de las variables de población como porcentaje"}
# histogramas datos poblacion  
analisis.cali.df %>% select(one_of(metricas.poblacion.mod[c(1,2,3,5,6)])) %>%
  gather( key = metricas.poblacion,
          value = valores,
          densidad_poblacion:superior_postgrado.porcentaje) %>%
  ggplot()+
  geom_histogram(aes(x = valores),bins = 30, 
                 color = "white", fill="magenta")+
  facet_wrap(~metricas.poblacion, scales = "free", ncol = 2)
```

Podemos notar que la transformación realizada al expresar las variables como porcentaje reduce la inclinación hacia la derecha de los histogramas e inclusive la corrige para el caso de personas con alguna limitación. 

Para finalizar con la inspección de los datos sobre la población se proveen el resumen estadístico de las variables.

```{r resumen-poblacion}
analisis.cali.df %>% select(one_of(c(metricas.poblacion[c(2,3,4,6,7)],metricas.poblacion.mod[c(1,2,3,5,6)]))) %>%
summary()
```

### Características de las viviendas

Además de las rasgos étnicos, condiciones de estudio y limitaciones de la población el censo de 2005 tiene disponibles datos sobre el tipo de viviendas (casa, apartamento, tipo cuarto, casa indígena, otros), y el uso habitacional, comercial y la cantidad de unidades especiales de alojamiento L.E.A dado a los predios. La vocación comercial o residencial de un barrio puede ser un factor en el desarrollo del arbolado urbano, ya sea por las condiciones físicas como por la intervención de sus habitantes. Estas variables pueden también expresarse como porcentaje de la cantidad de predios de vivienda en el caso de los tipos o como porcentaje de la cantidad de predios en el caso del uso como unidad de vivienda, económica o L.E.A.

A continuación presentamos el resumen, los mapas por sector urbano (figuras \@ref(fig:mapas-usopredios-cont) y \@ref(fig:mapas-usopredios-deciles))y los histogramas (figura \@ref(fig:hist-usopredios))de las variables sobre el uso de los predios.

```{r mapas-usopredios-cont, fig.asp=0.8,fig.cap="Mapas de las variables sobre el tipo de uso de los predios como porcentaje de la cantidad de predios (escala contínua)"}

pl_poblacion<-plots_map_su_df(analisis.cali.df,metricas.predios[c(13:15)])
grid.arrange(grobs =pl_poblacion, nrow =1)

```

```{r mapas-usopredios-deciles, fig.asp=0.8,fig.cap="Mapas de las variables sobre el tipo de uso de los predios como porcentaje de la cantidad de predios (en deciles)"}
su.f %>% dplyr::select(-area_su)  %>%
  left_join(metricas.predios.ntl.long, by = c("id"="SETU_CCDGO")) %>%
  filter(metricas.predios %in% metricas.predios[13:15]) %>%
  ggplot()+
  geom_polygon(aes(x= long, y = lat, group = group, fill = factor(valores)))+
  coord_equal()+
  scale_fill_viridis( name = "deciles",
                      direction = 1, 
                      discrete = T, 
                      na.value = "grey50",
                      guide = guide_legend(direction = "horizontal",
                                           label.position = "bottom",
                                           title.position = 'top',
                                           nrow = 1))+
  facet_wrap(~metricas.predios, nrow = 1)+
  tema_lgnd_abajo()
```

```{r hist-usopredios, fig.asp=0.7,fig.cap="Histogramas de las variables de uso de predios como porcentaje"}
#histogramas predios ----

analisis.cali.df %>% select(one_of(metricas.predios[13:15])) %>%
  gather( key = metricas.predios,
          value = valores,
          viviendas.porcentaje:LEA.porcentaje) %>%
  ggplot()+
  geom_histogram(aes(x = valores),bins = 30, 
                 color = "white", fill="steelblue")+
  facet_wrap(~metricas.predios, scales = "free", ncol = 1)
```

El uso de L.E.A tiene una distribución concentrada en uno pocos SU, por lo que podemos descartarla para los análisis de regresión. Existe también cierta complementariedad entre el uso de vivienda y los usos económicos de los predios, porque seguramente, si existe una correlación entre estas variables y la cobertura de copa o el acceso a espacios verdes una de las dos puede bastar para incluir esta dimensión en los modelos de regresion.

A continuación presentamos el resumen, los mapas por sector urbano (figuras \@ref(fig:mapas-viviendas-cont) y \@ref(fig:mapas-viviendas-deciles))y los histogramas (figura \@ref(fig:hist-viviendas))de las variables sobre los tipos de vivienda.

```{r mapas-viviendas-cont, fig.asp=0.8,fig.cap="Mapas de las variables sobre el tipo viviendas como porcentaje (escala contínua)"}

pl_poblacion<-plots_map_su_df(analisis.cali.df,metricas.predios[c(9:11)])
grid.arrange(grobs =pl_poblacion, nrow =1)

```

```{r mapas-viviendas-deciles, fig.asp=0.8,fig.cap="Mapas de las variables sobre el tipo viviendas como porcentaje (en deciles)"}
su.f %>% dplyr::select(-area_su)  %>%
  left_join(metricas.predios.ntl.long, by = c("id"="SETU_CCDGO")) %>%
  filter(metricas.predios %in% metricas.predios[9:11]) %>%
  ggplot()+
  geom_polygon(aes(x= long, y = lat, group = group, fill = factor(valores)))+
  coord_equal()+
  scale_fill_viridis( name = "deciles",
                      direction = 1, 
                      discrete = T, 
                      na.value = "grey50",
                      guide = guide_legend(direction = "horizontal",
                                           label.position = "bottom",
                                           title.position = 'top',
                                           nrow = 1))+
  facet_wrap(~metricas.predios, nrow = 1)+
  tema_lgnd_abajo()
```

```{r hist-viviendas, fig.asp=0.7,fig.cap="Histogramas de los tipo de vivienda como porcentaje"}
#histogramas predios ----

analisis.cali.df %>% select(one_of(metricas.predios[9:11])) %>%
  gather( key = metricas.predios,
          value = valores,
          casa.porcentaje:cuarto.porcentaje) %>%
  ggplot()+
  geom_histogram(aes(x = valores),bins = 30, 
                 color = "white", fill="steelblue")+
  facet_wrap(~metricas.predios, scales = "free", ncol = 1)
```

Esta primera inspección a los datos permitió descartar algunas variables a usar en los modelos de regresión sobre las coberturas y los espacios verdes, conocer la distribución espacial de los datos y perfilar las posibles variables a incluir. Sin embargo, la percepción suele ser engañosa, vemos patrones en todas partes, así que es necesario acompañar estas intuiciones con métricas estadísticas y gráficas sobre las relaciones entre las variables dependientes e independientes para ser más asertivos en las decisiones del proceso de modelado. 

## Análisis estadísticos

### Criterios y selección de sectores censales

Antes de iniciar un analaisis de regresion es importante establecer ciertos criterios pra inclusion o no de ciertos datos dentro del conjunto de varores para la regresion y calculo de la correlacion. Estos criterios estan ligados 
 creterios de excepcion de sectores urbanos a ser incluidos en el analsis de regresion:
 
- sectores sin personas
- sectores sin viviendas
- sectores area de espacio publico mayor que el 60 % del area del sector
- sectores area de calle mayor que el 80 % del area del sector
- sectores area privada mayor que el 90 % del area del sector

```{r code-excluidos, eval=FALSE, echo=TRUE}
 analisis.cali.df %>% 
   filter(is.na(personas_edad)) %>%
   select(SETU_CCDGO) -> sin_personas
 
 analisis.cali.df %>% 
   filter(uso_vivienda == 0) %>%
   select(SETU_CCDGO) -> sin_viviendas

 analisis.cali.df %>% 
   filter(area_ep.porcentaje > 0.6 ) %>%
   select(SETU_CCDGO)  -> ep_60
 
 analisis.cali.df %>% 
   filter(area_privada.porcentaje > 0.85 ) %>%
   select(SETU_CCDGO) -> privada_85
 
 analisis.cali.df %>% 
   filter(area_calle.porcentaje > 0.8 ) %>%
   select(SETU_CCDGO) -> calle_80
 
 analisis.cali.df %>% 
   filter(is.na(area_copa)) %>%
   select(SETU_CCDGO) -> sin_arboles_censado
 
 
 su.exc.apriori<-c("0204","1736",# sector con alto porcentaje no urbanizado
                   "1709",# maroria del area por fuera del perimetro urbano
                   "1317")# laguna del pandaje
```

Además de estos criterios se excluyeron los sectores donde está la Laguna el Pondaje, que cubre una porción muy importante del sector que no se ve reflejado en las otras métricas, los sectores con una porción mayor al 60% por fuera del perímetro urbano o sin urbanización visible en las imagenes satelitales. Así los sectores excluidos del análisis se muestran en los mapas \@ref(fig:mapa-excluidos) y \@ref(fig:mapa-excluidos-tipo) por criterio usado. 

```{r mapa-excluidos, fig.cap="Mapa de los sectores excluidos"}
ggplot()+
   geom_polygon(data = su.f,
                aes(x = long ,y = lat, group = group),
                fill = "grey70")+
   geom_polygon(data = subset(su.f, id %in% su.exc$SETU_CCDGO),
                aes(x = long ,y = lat, group = group,fill = "descartados"),
                alpha = 0.5)+
   coord_equal()+
   scale_fill_manual(name ="SU",values = "blue")+
   theme_void()
```

```{r mapa-excluidos-tipo, fig.cap="Mapa de los sectores excluidos por criterio usado"}
 ggplot()+
   geom_polygon(data = su.f,
                aes(x = long ,y = lat, group = group),
                fill = "grey70")+
   geom_polygon(data = subset(su.f, id %in% sin_arboles_censado$SETU_CCDGO),
                aes(x = long ,y = lat, group = group,fill = "sin arboles censados"))+
   geom_polygon(data = subset(su.f, id %in% sin_personas$SETU_CCDGO),
                aes(x = long ,y = lat, group = group,fill = "sin personas"))+
   geom_polygon(data = subset(su.f, id %in% sin_viviendas$SETU_CCDGO),
                aes(x = long ,y = lat, group = group,fill = "sin viviendas"))+
   geom_polygon(data = subset(su.f, id %in% ep_60$SETU_CCDGO),
                aes(x = long ,y = lat, group = group,fill = "Ep > 60%"))+
   geom_polygon(data = subset(su.f, id %in% privada_85$SETU_CCDGO),
                aes(x = long ,y = lat, group = group,fill = "Privado > 85%"))+
   geom_polygon(data = subset(su.f, id %in% calle_80$SETU_CCDGO),
                aes(x = long ,y = lat, group = group,fill = "Calle > 80%"))+
   geom_polygon(data = subset(su.f, id %in% su.exc.apriori),
                aes(x = long ,y = lat, group = group,fill = "a priori"))+
   geom_text_repel( data = data.frame(centroides.su) %>% 
                filter( setu_ccgdo %in% su.exc.criterios$SETU_CCDGO),
              aes(x = x, y =y, label =setu_ccgdo))+
   
   coord_equal()+
  scale_fill_manual(name="Criterios",values = brewer.pal(7,"Set1"))+
   theme_void()
```


### Modelando la cobertura de copa

Las variables a incluir en los modelos lineales deben cumplir una serie de condiciones para ser elegidas como candidatas:

- *Mostrar una correlación fuerte* (típicamente mayor a 0.6 se considera una asociación fuerte).
- *Las variables independientes o predictoras no deben estar fuertemente correlacionadas entre ellas*.
- *Las observaciones deben ser independientes*. En nuestro caso significa que no debe existir relación espacial o temporal entre los diferentes sectores. Justamente esto se pondrá a prueba con los test estadísticos y los graficos de diagnostico sobre la distribución de los residuos de la regresión: se espera que dicha dependencia esté motivada por la vecindad de los sectores.
- *Las variables dependientes e independientes deben tener una distribución normal*. Esta condición no suele ser estricta, inclusive algunos textos como @ , afirman que lo importante es que calcular los coeficientes de la regresión obtengamos una distribución normal de los residuos (sin ningún patrón, ruido). De no ser así, es posible que las variables no sean independiente y que exista información significativa en los residuos, por ejemplo, porque existe autocorrelación espacial en la variable dependiente y entonces la regresión lineal no obtiene resultados confiables para los coeficientes.


Para hacer más tratable y gradual el proceso de complejizar el modelo iniciaremos el análisis con las variables sobre la población, que son las de mayor interés en un estudio dado su enfoque en la  justicia ambiental, para luego incorporar las variables de los dominios relacionados con el uso de los predios, los tipos de viviendas y la existencia de espacios verdes como parques, bulevares, escenarios deportivos o plazas, que como se vio en la sección \@ref(sec-ca2015) (revisar figura \@ref(fig:au-emplaz-veg))  alojan una cantidad considerable de los individuos arbóreos de la ciudad.

Las variables a modelar son la área de copa en metros^2^ (`area_copa`) y la cobertura de copa como porcentaje del área pública total (`cobertura_copa.ap`), conformda por la vías y calles más el área de espacio públicos) (ver figura \@ref(fig:mapa-copa-dep)).

```{r mapa-copa-dep, fig.cap="Sectores urbanos de las variables dependientes sobre cobertura de copa"}
su.f %>% dplyr::select(-area_su)  %>%
  left_join(dep.arboles.ntl.long,by = c("id"="SETU_CCDGO")) %>%
  filter(dep.arboles %in% dependientes.arboles) %>%
  ggplot()+
  geom_polygon(data = su.f, aes(x= long, y = lat, group = group), fill = "grey60")+
  geom_polygon(aes(x= long, y = lat, group = group, fill = factor(valores)))+
  coord_equal()+
  scale_fill_viridis( name = "deciles",
                      direction = 1, 
                      discrete = T, 
                      na.value = "grey50",
                      guide = guide_legend(direction = "horizontal",
                                           label.position = "bottom",
                                           title.position = 'top',
                                           nrow = 1))+
  facet_wrap(~dep.arboles, nrow = 1)+
  tema_lgnd_abajo()

```



#### Correlaciones y gráficos de dispersión entre pares

Para asegurarnos de que las variables no están correlacionadas entre si, usaremos los coeficientes de correlación de Pearson, usado para detectar relaciones lineales, usualmente en variables con distribución normal, y el coeficiente de Spearman para detectar relaciones en variables con otras distribuciones o que exhiben relaciones no lineales. Para tener una idea más amplia sobre esa relación que expresan los coeficiente de correlación se incluyen gráficas de dispersión entre las variables independientes, y con las dependientes.


En la figura \@ref(fig:bivar-poblacion-abs) se explora las relaciones entre las variables de población en las unidades originales de los datos (número de personas); la matriz triangular superior muestra los coeficientes de correlación de Pearson, la diagonal contiene el histogram de frecuencias de la variable y la matriz triangular inferior muestra un gráfico de dispersión y la línea de tendencia usando un modelo lineal entre cada par de variables. Es notoria la alta correlación entre tener ningún estudio y tener alguna limitación física (0.88);  pertenecer a una comunidad afrodescendiente y carecer de estudios (0.92) o ser afrodescendiente y tener alguna limitación (0.88). Esto representa una suma de condiciones desfavorables relacionadas entre sí, que desde el punta del vista del modelo sólo podrán ser representadas por una de las variables, la que mejor se relacione con la cobertura de copa y evitar así colinealidad entre los predictores.



```{r bivar-poblacion-abs, fig.asp=1, fig.cap="Comparación por pares entre predictores de población"}
ggpairs(
  regresion.arboles[,indep.poblacion.abs], lower = list(continuous = wrap(lowerFn, method = "lm")),
  diag = list(continuous = wrap("barDiag", colour = "white",fill ="steelblue")),
  upper = list(continuous = wrap("cor", size = 4)),
  title = "Comparación por pares entre predictores de población"
)+ theme_grey(base_size = 8)

```

Cuando realizamos la misma comparación entre las variables porcentuales (más la densidad poblacional) se observan patrones similares(ver figura \@ref(fig:bivar-poblacion-mod)): existe una alta correlación negativa entre el porcentaje de población afro de un sector y la tenencia de estudios superiores (-0.71), una fuerte asociación positiva entre el porcentaje de personas afro de un sector y el porcentaje de personas que carecen de estudios (0.68). También hay una fuerte relación inversa entre el porcentaje de personas de un sector sin estudios y el porcentaje de ellos que tiene estudios superiores (-0.8). Estas variables evitaremos usarlas como predictores en una misma formulación para no sesgar la estimación con problemas de colinealidad. Existe también una asociación, no tan fuerte pero importante, entre la densidad de población y sectores con mayor porcentaje de personas afro (0.47) y una asociación negativa entre la densidad de población y el porcentaje de personas con estudios superiores (-0.51). Estos resultados hablan de una concentración de condiciones desfavorables para la población, posiblemente acompañado de una segregación racial alta.

```{r bivar-poblacion-mod, fig.asp=1, fig.cap="Comparación por pares entre predictores de población porcentuales"}
ggpairs(
  regresion.arboles[,indep.poblacion.percent], lower = list(continuous = wrap(lowerFn, method = "lm")),
  diag = list(continuous = wrap("barDiag", colour = "white",fill ="steelblue")),
  upper = list(continuous = wrap("cor", size = 4)),
  title = "Comparación por pares entre predictores de población porcentuales y la densidad de población"
)+ theme_grey(base_size = 8)

```

Para completar la inspección de las relaciones entre predictores la figura \@ref(fig:bivar-poblacion-mod-abs) muestra la relación entre las variables provistas en por el censo de población en unidades de personas y las versiones porcentuales que calculamos. El número en el recuadro de cada subgráfica es el coeficiente de correlación de Pearson. Aunque procuraremos incluir cada una de las condiciones evitando redundar al incluir la misma variable en sus dos versiones en un mismo modelo, es interesante que la división entre el número de personas totales del sector atenúa la correlación entre la variable observada y su contraparte porcentual.

```{r bivar-poblacion-mod-abs, fig.asp=1, fig.cap="Comparación por pares entre predictores de población porcentuales y predictores en unidades de personas"}
# entre predictoras y version porcentual
ggduo(regresion.arboles,
      columnsX =indep.poblacion.abs, 
      columnsY =indep.poblacion.percent,
      types = list(continuous = wrap(lm_with_cor)),
  title = "Comparación por pares entre predictores en unidades de personas y porcentuales"
)+ theme_grey(base_size = 8)

```


Ya que hemos explorado visualmente la dispersión entre los datos crudos, podemos usar forma resumida, usando gráficos de azulejos o de matriz para consultar la intensidad de estas relaciones, no solo las lineales que revela el coeficiente de Pearson, sino usando el coeficiente de Spearman. La figura \@ref() sintetiza las relaciones lineales entre las variables dependientes, mientras que la figura \@ref() lo hace para las no lineales. 

```{r tile-poblacion-pearson, fig.asp=1,fig.cap="Coeficiente Pearson entre varibles de población"} 
pintar_corrmatrix(regresion.arboles,indep.poblacion)+
  labs(title="Coeficiente Pearson entre varibles de población")


```

```{r tile-poblacion-spearman, fig.asp=1,fig.cap="Coeficiente Spearman entre varibles de población"}
pintar_corrmatrix(regresion.arboles,indep.poblacion, method_cor = "spearman")+
  labs(title="Coeficiente Spearman entre varibles de población")

```

Para seleccionar las variables que mejor predicen la cobertura de copa aplicamos un procedimiento análogo al realizado con las variables dependientes entre sí. Con base en los coeficientes de correlación de Pearson (figura \@ref(fig:tile-copa-poblacion-pearson)) y Spearman (figura \@ref(fig:tile-copa-poblacion-spearman)) entre las variables dependientes e independientes, y teniendo en cuenta las restricciones de colinealidad entre las variables dependientes, seleccionamos las variables a usar en el modelo lineal. 

Así pues, para el área de copa (`area_copa`) los predictores seleccionados son`` `r str_c(indep.poblacion.copa.sel, collapse = ", ") ` `` y para la cobertura de copa en área pública (`cobertura_copa.ap`) los predictores seleccionados son`` `r str_c(indep.poblacion.copa.ap.sel, collapse = ", ") ` `` 

```{r tile-copa-poblacion-pearson, fig.asp=0.65,fig.cap="Coeficiente Pearson entre coberturas de copa y variables de población"}
pintar_corrmatrix_XY(regresion.arboles,x=indep.poblacion, y=dependientes.arboles)+
  labs(title="Pearson entre cobertura de copa y variables de población")

```


```{r tile-copa-poblacion-spearman, fig.asp=0.65,fig.cap="Coeficiente Spearman entre coberturas de copa y variables de población"}
pintar_corrmatrix_XY(regresion.arboles,x=indep.poblacion, y=dependientes.arboles, method_cor = "spearman")+
  labs(title="Spearman entre cobertura de copa y variables de población")
```


Se recomienda especificar correctamente los modelos lineales cuando existen relaciones con correlaciones negativas, pues es posible que sea mejor usar el inverso de la variable. Para probar si al hacerlo dichas variables tienen incrementos en los coeficientes de correlación respecto de las variables dependientes. Como se observa en las figuras \@ref(fig:duolin-poblacion-copa) y \@ref(fig:duonolin-poblacioninv-copa) las mejoras son solo en la varible de `afro.porcentaje.inv` en el segundo dígito decimal. 




```{r duolin-poblacion-copa,cache=FALSE,fig.asp=0.62,fig.cap="Gráficas de dispersión entre predictores de población y variables dependientes de la cobertura de copa (regresión lineal + coeficiente de Pearson)"}
# entre predictoras y dependientes no lineal
ggduo(regresion.arboles,
      columnsX =c("superior_postgrado",indep.poblacion.copa.ap.sel),
      columnsY =dependientes.arboles,
      types = list(continuous = wrap(lm_with_cor)),
      # types = list(continuous = wrap(lm_with_cor,
      #                                method_cor = "spearman",
      #                                method_smooth= "loess")),
      title = "Predictores de población vs. cobertura de copa (regresión lineal + Pearson)"
)+ theme_grey(base_size = 8)


```

```{r duonolin-poblacioninv-copa, cache=FALSE,fig.asp=0.62,fig.cap="Gráficas de dispersión entre predictores de población (usando el inverso de la variable con correlaciones negativas: $f(x)=\\frac{1}{x+1}$) y las variables dependientes de la cobertura de copa ( regresión lineal  + coeficiente de Pearson)"}
# entre predictoras y dependientes no lineal
ggduo(regresion.arboles,
      columnsX =c("superior_postgrado",indep.poblacion.cobertura.ap), 
      columnsY =dependientes.arboles,
      types = list(continuous = wrap(lm_with_cor)),
      # types = list(continuous = wrap(lm_with_cor,
      #                                method_cor = "spearman",
      #                                method_smooth= "loess")),
title = "Predictores de población (invertido) vs. cobertura de copa (regresión lineal + Pearson)"
)+ theme_grey(base_size = 8)
```


#### Modelos de regresión lineal 

Antes ajustar los modelos suele ser común en los modelos de regresión ajustar la distribución de las variables dependientes (y a veces las independientes) por motivos teóricos usando transformaciones logarítmicas o de raíz cuadra para eliminar no linealidades entre las variables dependientes y las independientes, y reducir posibles fenómenos de heterocedasticidad debido a estas no-linealidades. Siguiendo el ejemplo, ajustaremos 5 modelos: uno por cada variable dependiente en sus tres versiones, sin transforma, con una tranformacion logaritmica (exepto para la cobertura_copa.ap pues por tener valores ya entre [0,1] produce valores negativos) y otra de la raiz cuadra. 

Los histogramas de las variables dependientes tranformadas se muestran en la figura \@ref(fig:hist-copa-trnsf). 
```{r hist-copa-trnsf, fig.asp=1.5,fig.cap="Histogramas de las variables de cobertura de copa transformadas"}
# histogramas 

regresion.arboles %>% select(one_of(c(dependientes.copa.trnsf,dependientes.copa.ap.trnsf))) %>%
  gather( key = indep.poblacion,
          value = valores,
          1:5) %>%
  ggplot()+
  geom_histogram(aes(x = valores),bins = 30, 
                 color = "white", fill="forestgreen")+
  facet_wrap(~indep.poblacion, scales = "free", ncol = 1)

```

Las mejoras sobre el modelo de regresión que puedan hacer estas transformaciones pueden apreciarse en los gráficos de dispersión de las variables independientes transformadas vs. las dependientes o/y en los coeficientes de correlación de Pearson. Como se observa en las figuras \@ref(fig:duolin-poblacion-copa-trnsf) y \@ref(fig:duolin-poblacion-cob-trnsf) hay leves mejoras al aplicar las transformaciones.   

```{r duolin-poblacion-copa-trnsf,cache=FALSE,fig.asp=0.62,fig.cap="Gráficas de dispersión entre predictores de población y variables dependientes de la área de copa transformdas (regresión lineal + coeficiente de Pearson)"}
# entre predictoras y dependientes no lineal
ggduo(regresion.arboles,
      columnsX =indep.poblacion.area_copa, 
      columnsY =dependientes.copa.trnsf,
      types = list(continuous = wrap(lm_with_cor)),
      title = "Predictores de población vs. área de copa transformda (regresión lineal + Pearson)"
)+ theme_grey(base_size = 8)


```


```{r duolin-poblacion-cob-trnsf,cache=FALSE,fig.asp=0.62,fig.cap="Gráficas de dispersión entre predictores de población y variables dependientes de la cobertura de copa transformdas (regresión lineal + coeficiente de Pearson)"}
# entre predictoras y dependientes no lineal
ggduo(regresion.arboles,
      columnsX =indep.poblacion.copa.ap.sel, 
      columnsY =dependientes.copa.ap.trnsf,
      types = list(continuous = wrap(lm_with_cor)),
      title = "Predictores de población vs. cobertura de copa transformda (regresión lineal + Pearson)"
)+ theme_grey(base_size = 8)


```

También es sabido que dividir o multiplicar por alguna constante no tiene ningún efecto en la calidad de la estimación , pero sí sobre los coeficientes de la regresión. Esto suele ser sensible a la hora de interpretar los cambios marginales de cada una de las variables independientes y su efecto sobre la variable dependiente. Sin embargo, lo que interesa para este estudio no es la interpretación de esos cambio sino la importancia relativa de cada variable y comparar los cambios de los coeficientes de regresión para el ajuste de cada modelo y/o las mejoras que pueda operar un modelos autorregresivo en caso de encontrase autocorrelación en los residuos de la regresión lineal. Por esta razón, normalizar los valores puede ser una ventaja pues mantiene los coeficiente mejor acotados. La normalización se aplica posterior a las transformaciones propuestas y se realiza dividiendo por el máximo valor de los datos de cada variable para mantener valores en el intervalo [0,1], dado que los valores son todos iguales o mayores que 0.


El siguiente código en **R** crea las 5 regresiones lineales propuestas.
```{r code-lm-area_copa, echo=T}

# area de copa
dependiente <- "area_copa"
independientes  <- indep.poblacion.area_copa
var_names<-c(dependiente,names(regresion.arboles[,independientes]))
regresion.arboles.mn<-max_nomalization(regresion.arboles,var_names)
lm.mn.area_copa.sel<-crear_lm_from_df(regresion.arboles.mn)
summary(lm.mn.area_copa.sel)


```


```{r code-lm-log.area_copa,echo=T}


dependiente <- "log.area_copa"
independientes  <- indep.poblacion.area_copa
var_names<-c(dependiente,names(regresion.arboles[,independientes]))
regresion.arboles.mn<-max_nomalization(regresion.arboles,var_names)
lm.mxn.log.area_copa.sel<-crear_lm_from_df(regresion.arboles.mn)
modelo<-crear_lm_from_df(regresion.arboles.mn)
summary(lm.mxn.log.area_copa.sel)
```



```{r code-lm-sqrt.area_copa,echo=T}

dependiente <- "sqrt.area_copa"
independientes  <- indep.poblacion.area_copa
var_names<-c(dependiente,names(regresion.arboles[,independientes]))
regresion.arboles.mn<-max_nomalization(regresion.arboles,var_names)
lm.mxn.sqrt.area_copa.sel<-crear_lm_from_df(regresion.arboles.mn)
summary(lm.mxn.sqrt.area_copa.sel)
```


```{r code-lm-cobertura_copa.ap,echo=T}


dependiente <- "cobertura_copa.ap"
independientes  <- indep.poblacion.cobertura.ap
var_names<-c(dependiente,names(regresion.arboles[,independientes]))
regresion.arboles.mn<-max_nomalization(regresion.arboles,var_names)
lm.mxn.cobertura_copa.ap<-crear_lm_from_df(regresion.arboles.mn)
summary(lm.mxn.cobertura_copa.ap)

```


```{r code-lm-sqrt.cobertura_copa.ap,echo=T}


dependiente <- "sqrt.cobertura_copa.ap"
independientes  <- indep.poblacion.cobertura.ap
var_names<-c(dependiente,names(regresion.arboles[,independientes]))
regresion.arboles.mn<-max_nomalization(regresion.arboles,var_names)
lm.mxn.sqrt.cobertura_copa.ap<-crear_lm_from_df(regresion.arboles.mn)
summary(lm.mxn.sqrt.cobertura_copa.ap)
```


### Acceso a espacios verdes

#### Criterios y selección de sectores censales

#### Correlaciones y distribuciones bivaridas

#### Modelos de regresion lineal 


## Análisis geoestadísticos

